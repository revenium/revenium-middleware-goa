# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is a Go middleware library for the [goa-ai](https://goa.design/goa-ai/) agent framework. It captures LLM completion metrics (tokens, timing, model) and agent activity (tool calls, workflow phases) and sends them asynchronously to the Revenium metering API.

Module: `github.com/revenium/revenium-middleware-goa`

## Build Commands

```bash
go build ./...        # Build the module
go test ./...         # Run tests (none yet)
go fmt ./...          # Format code
go vet ./...          # Static analysis
go mod tidy           # Clean up dependencies
```

## Architecture

The middleware uses a **decorator/wrapper pattern** with two integration points into the goa-ai framework:

### Integration Points

1. **MeteringPlanner** (`planner.go`) — Wraps `planner.Planner` interface
   - Intercepts `PlanStart()` and `PlanResume()` lifecycle events
   - Injects a metering-aware `ModelClient()` that captures LLM completions
   - Handles trace context creation and propagation

2. **MeteringSink** (`sink.go`) — Wraps `stream.Sink` interface
   - Observes workflow lifecycle events (ToolStart/End, Workflow phases)
   - Pre-registers child run trace mappings for multi-agent coordination

### Core Components

- **Meter** (`metering.go`) — Central orchestrator for async payload delivery with retry logic
- **meteringClient** (`model_client.go`) — Wraps `model.Client` to intercept `Complete()` and `Stream()` calls
- **Config** (`config.go`) — Functional options pattern with environment variable fallback
- **TraceContext** (`context.go`) — Context-based trace correlation across agent boundaries

### Data Flow

```
Agent Planner → MeteringPlanner → meteringClient → LLM Provider
                                       ↓
                                    Meter.SendAsync() → Revenium API
```

### Multi-Agent Trace Correlation

- `traceId` — Shared across all agents in the same interaction (generated by top-level agent)
- `transactionId` — Unique per agent run (the runtime's RunID)
- `parentTransactionId` — Links child agent payloads to parent

The Meter maintains a trace registry (`sync.Map`) that maps RunIDs to TraceIDs for cross-agent correlation.

## Key Patterns

- **Functional options**: `NewMeter(WithAPIKey(...), WithEnvironment(...))`
- **Fire-and-forget async**: Metering never blocks agent execution
- **Graceful shutdown**: `defer meter.Flush()` ensures completion
- **Retry with backoff**: 3 retries at 1s, 2s, 4s intervals
- **Squad auto-detection**: Agent ID prefix before `.` becomes squad (e.g., `demo.assistant` → `demo`)

## Configuration Precedence

1. Programmatic options (highest)
2. Environment variables (`REVENIUM_API_KEY`, `REVENIUM_METERING_BASE_URL`, etc.)
3. Defaults (`https://api.revenium.ai`)

## Environment Variables

| Variable | Required | Description |
|---|---|---|
| `REVENIUM_API_KEY` | Yes | API key (must start with `hak_`) |
| `REVENIUM_METERING_BASE_URL` | No | API base URL |
| `REVENIUM_ENVIRONMENT` | No | Deployment environment |
| `REVENIUM_SQUAD` | No | Override squad identifier |
